{% extends "mobile_base.html" %}

{% load staticfiles %}

{% block title %}
座位信息 - 清华紫荆之声
{% endblock %}

{% block css %}
<link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block js %}

	<script src="{% static "js/jquery.js" %}"></script>
	<script src="{% static "js/bootstrap.min.js" %}"></script>
	<script src="{% static "js/select.js" %}"></script>
	
	<script>
    function ajaxForm() {
		if(g_area == 0)
			g_area = 'A';
		else if(g_area == 1)
			g_area = 'B';
		else if(g_area == 2)
			g_area = 'C';
		else 
			g_area = -1;
			
		var area = document.getElementById("area");
		var row = document.getElementById("row");
		var col = document.getElementById("col");
		area.value = g_area;
		row.value = g_row;
		col.value = g_col;
        submitSelection('{{ act_id }}', '{{ ticket_row }}', '{{ ticket_id }}'); 
    }
    window.addEventListener('load', function() {showValidation({{ ticket_row }});}, false);

    </script>
{% endblock %}

{% block theme %}
    “{{ act_name }}”选座系统
{% endblock %}

{% block content %}
	
    <div style="display:none;" id = "idString">
	{{seat}}
	</div>
    {% include 'activityphoto.html' %}
	<div class="details-wrapper img-wrapper" style="text-align:center;margin:20px 0">
	    <div class="img-inner">
	        <img class="details-img" width="80%" height="80%" src="{{ act_menu  }}" />
	    </div>
	</div>

   	<div class="container-fluid" style="text-align:center">
		<div class="row-fluid">
			<div class="span12">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h4 class="text-center" class="panel-title" style="font-family:微软雅黑;font-weight:bold">座位图</h4>
					</div>
					<div class="panel-body"  >
						<div >
							<img src="http://pimg.damai.cn/perform/project/292/29211_seat.jpg" width="100%"/>
						</div>
					</div>
				</div>
				<div class="panel panel-default">
					<div class="panel-heading">
						<h4 class="text-center" class="panel-title" style="font-family:微软雅黑;font-weight:bold">选择座位</h4>
					</div>
					<div id="validationHolder" class="panel-body">
						<form id="seatSelect" class="form-horizontal"  action="{% url "userpage.views.selection_view" %}" method="post" role="form"  onsubmit="return false;">
							{% csrf_token %}
							<div class="form-group">
								<div class="col-sm-2">
									<p>请选择区域</p>
									<select class="form-control" id="area" onchange="areaClick(this[selectedIndex].value);" name="area" required="required">
									  
									</select>
								</div>
							</div>
							<div class="form-group">
								<div class="col-sm-2">
									<p>请选择排</p>
									<select class="form-control" id="row" onchange="rowClick(this[selectedIndex].value);" name="row" required="required">
									
									</select>	
								</div>
							</div>
							<div class="form-group">
								<div class="col-sm-2">
									<p>请选择座号</p>
									<select class="form-control" id="col" name="col" required="required" onchange="colClick(this[selectedIndex].value);">
									
									</select>	
								</div>
							</div>
							<div class="form-group" id="submitGroup">
								<div class="col-sm-offset-1 col-sm-10">
									<button onclick="ajaxForm();" class="btn btn-primary" id="submitBtn">确认</button>
									<p class="help-block" id="helpLoading" style="display: none"><img src="{% static "img/loading.gif" %}">正在选座，请稍候...</p>
              						<p class="help-block" id="helpSubmit"></p>
								</div>
							</div>
						</form>
					</div>
					<div id="successHolder" style="display: none; text-align:center" >
				        <img src="{% static "img/success.png" %}" />
				        <p>选座成功！</p>
				        <p>您已经可以参加活动了！</p>
				    </div>
				</div>
			</div>
		</div>
	</div>
	
<script>
var g_seats=[];
var g_area;
var g_row;
var g_col;

function load(){
var x=document.getElementById("idString");
var strs = x.innerHTML.split("s");
var l = strs.length;
for(i in strs)
{
	if(i != 0 && i != l-1)
	{
		var str = strs[i].split("_");
		var row = parseInt(str[1]);
		var col = parseInt(str[2]);
		if(str[0] == "A")
			{
				if(g_seats[0] == undefined)
				{
					g_seats[0]=[];
				}
				if(g_seats[0][row] == undefined)
					{
						g_seats[0][row]=[];
					}
				g_seats[0][row][col]=1;		
			}
		else if(str[0] == "B")
			{
				if(g_seats[1] == undefined)
				{
					g_seats[1]=[];
				}
				if(g_seats[1][row] == undefined)
					{
						g_seats[1][row]=[];
					}
				g_seats[1][row][col]=1;
				
			}
		else
			{
				if(g_seats[2] == undefined)
				{
					g_seats[2]=[];
				}
				if(g_seats[2][row] == undefined)
				{
					g_seats[2][row]=[];
				}
				g_seats[2][row][col]=1;			
			}
	}
}

var area = document.getElementById("area");
var row = document.getElementById("row");
var col = document.getElementById("col");
var para_area = document.createElement("option");
var para_row = document.createElement("option");
var para_col = document.createElement("option");
para_area.value = -1;
para_area.innerHTML = "随机";
area.appendChild(para_area);
para_row.value = -1;
g_area = -1;
para_row.innerHTML = "随机";
row.appendChild(para_row);
g_row = -1;
para_col.value = -1;
para_col.innerHTML = "随机";
col.appendChild(para_col);
g_col = -1;
for(i in g_seats)
{
var para_area = document.createElement("option");

if(i == 0)
{
	para_area.innerHTML = "红色区";
	para_area.value="A";
	}
else if(i == 1)
{
	para_area.innerHTML = "蓝色区";
	para_area.value="B";
	}
else 
{
	para_area.innerHTML = "绿色区";
	para_area.value="C";
	}
area.appendChild(para_area);
}
}

function areaClick(val){
	var row = document.getElementById("row");
	var col = document.getElementById("col");
	while(row.hasChildNodes()) //当div下还存在子节点时 循环继续
    {
        row.removeChild(row.firstChild);
    }
	while(col.hasChildNodes()) //当div下还存在子节点时 循环继续
    {
        col.removeChild(col.firstChild);
    }
	var para_row = document.createElement("option");
	para_row.value = -1;
	para_row.innerHTML = "随机";
	row.appendChild(para_row);
	g_row = -1;
	var para_col = document.createElement("option");
	para_col.value = -1;
	para_col.innerHTML = "随机";
	col.appendChild(para_col);
	g_col = -1;
	if(val == "A")
	{
		g_area = 0;
		for(i in g_seats[0])
		{
			var para_row = document.createElement("option");
			para_row.value = i;
			para_row.innerHTML = i;
			row.appendChild(para_row);
		}
	}
	else if(val == "B")
	{
		g_area = 1;
		for(i in g_seats[1])
		{
			var para_row = document.createElement("option");
			para_row.value = i;
			para_row.innerHTML = i;
			row.appendChild(para_row);
		}
	}
	else if(val == "C")
	{
		g_area = 2;
		for(i in g_seats[2])
		{
			var para_row = document.createElement("option");
			para_row.value = i;
			para_row.innerHTML = i;
			row.appendChild(para_row);
		}
	}
	else
	{
		g_area = -1;
	}
}

function rowClick(val){
	g_row = val;
	var col = document.getElementById("col");
	while(col.hasChildNodes()) //当div下还存在子节点时 循环继续
    {
        col.removeChild(col.firstChild);
    }
	var para_col = document.createElement("option");
	para_col.value = -1;
	para_col.innerHTML = "随机";
	col.appendChild(para_col);
	g_col = -1;
	if(val != -1)
	{
	for(i in g_seats[g_area][g_row])
	{
		var para_col = document.createElement("option");
		para_col.value = i;
	    para_col.innerHTML = i;
		col.appendChild(para_col);
	}		
	}
}

function colClick(val){
	g_col = val;
}

document.onload = load();
</script>

{% endblock %}